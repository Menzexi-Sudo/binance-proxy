const express = require('express');
const crypto = require('crypto');
const fetch = require('node-fetch');

const app = express();
const PORT = process.env.PORT || 3000;

// é…ç½®
const CONFIG = {
  BINANCE_API_KEY: process.env.BINANCE_API_KEY || '',
  BINANCE_API_SECRET: process.env.BINANCE_API_SECRET || '',
  BINANCE_SPOT_URL: 'https://api.binance.com',
  BINANCE_FUTURES_URL: 'https://fapi.binance.com',
};

// CORSä¸­é—´ä»¶
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type');
  if (req.method === 'OPTIONS') {
    return res.sendStatus(200);
  }
  next();
});

// ä¸»é¡µ
app.get('/', (req, res) => {
  res.send(`
    <html>
      <head>
        <meta charset="UTF-8">
        <title>å¸å®‰APIä»£ç†</title>
        <style>
          body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
          .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
          h1 { color: #f0b90b; }
          .status { background: #28a745; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; }
          code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; }
          .endpoint { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #f0b90b; border-radius: 4px; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>ğŸš€ å¸å®‰APIä»£ç†æœåŠ¡</h1>
          <p><span class="status">âœ“ è¿è¡Œä¸­</span></p >
          
          <h2>ğŸ“¡ å¯ç”¨ç«¯ç‚¹</h2>
          
          <div class="endpoint">
            <strong>1. æµ‹è¯•è¿æ¥</strong><br>
            <code>GET /test</code>
          </div>
          
          <div class="endpoint">
            <strong>2. è·å–Kçº¿æ•°æ®</strong><br>
            <code>GET /klines?symbol=BTCUSDT&interval=15m&limit=50</code>
          </div>
          
          <div class="endpoint">
            <strong>3. è·å–è´¦æˆ·ä¿¡æ¯</strong><br>
            <code>GET /account</code>
          </div>
          
          <div class="endpoint">
            <strong>4. è·å–æŒä»“ä¿¡æ¯</strong><br>
            <code>GET /positions</code>
          </div>
          
          <p>éƒ¨ç½²æ—¶é—´: ${new Date().toISOString()}</p >
        </div>
      </body>
    </html>
  `);
});

// æµ‹è¯•ç«¯ç‚¹
app.get('/test', (req, res) => {
  res.json({
    status: 'success',
    message: 'å¸å®‰APIä»£ç†è¿è¡Œæ­£å¸¸!',
    timestamp: new Date().toISOString(),
    endpoints: ['/test', '/klines', '/account', '/positions']
  });
});

// è·å–Kçº¿æ•°æ®
app.get('/klines', async (req, res) => {
  try {
    const symbol = req.query.symbol || 'BTCUSDT';
    const interval = req.query.interval || '15m';
    const limit = req.query.limit || '50';
    
    const url = `${CONFIG.BINANCE_SPOT_URL}/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
    
    console.log('è¯·æ±‚å¸å®‰URL:', url);
    
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json'
      }
    });
    
    const data = await response.json();
    
    console.log('å¸å®‰å“åº”çŠ¶æ€:', response.status);
    
    if (!Array.isArray(data)) {
      console.error('å¸å®‰è¿”å›æ•°æ®ä¸æ˜¯æ•°ç»„:', data);
      throw new Error('å¸å®‰è¿”å›æ•°æ®æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
    }
    
    const formatted = data.map(candle => ({
      openTime: candle[0],
      open: candle[1],
      high: candle[2],
      low: candle[3],
      close: candle[4],
      volume: candle[5],
      closeTime: candle[6],
      quoteVolume: candle[7],
      trades: candle[8]
    }));
    
    res.json({
      success: true,
      symbol: symbol,
      interval: interval,
      count: formatted.length,
      data: formatted
    });
    
  } catch (error) {
    console.error('è·å–Kçº¿æ•°æ®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// è·å–è´¦æˆ·ä¿¡æ¯
app.get('/account', async (req, res) => {
  try {
    if (!CONFIG.BINANCE_API_KEY) {
      return res.status(401).json({
        error: 'è¯·å…ˆé…ç½®å¸å®‰APIå¯†é’¥'
      });
    }
    
    const timestamp = Date.now();
    const queryString = `timestamp=${timestamp}`;
    const signature = crypto
      .createHmac('sha256', CONFIG.BINANCE_API_SECRET)
      .update(queryString)
      .digest('hex');
    
    const url = `${CONFIG.BINANCE_FUTURES_URL}/fapi/v2/account?${queryString}&signature=${signature}`;
    
    const response = await fetch(url, {
      headers: {
        'X-MBX-APIKEY': CONFIG.BINANCE_API_KEY
      }
    });
    
    const data = await response.json();
    
    res.json({
      success: true,
      data: data
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// è·å–æŒä»“ä¿¡æ¯
app.get('/positions', async (req, res) => {
  try {
    if (!CONFIG.BINANCE_API_KEY) {
      return res.status(401).json({
        error: 'è¯·å…ˆé…ç½®å¸å®‰APIå¯†é’¥'
        });
    }
    
    const timestamp = Date.now();
    const queryString = `timestamp=${timestamp}`;
    const signature = crypto
      .createHmac('sha256', CONFIG.BINANCE_API_SECRET)
      .update(queryString)
      .digest('hex');
    
    const url = `${CONFIG.BINANCE_FUTURES_URL}/fapi/v2/positionRisk?${queryString}&signature=${signature}`;
    
    const response = await fetch(url, {
      headers: {
        'X-MBX-APIKEY': CONFIG.BINANCE_API_KEY
      }
    });
    
    const data = await response.json();
    const activePositions = data.filter(pos => parseFloat(pos.positionAmt) !== 0);
    
    res.json({
      success: true,
      count: activePositions.length,
      data: activePositions
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

app.listen(PORT, () => {
  console.log(`å¸å®‰APIä»£ç†è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
});
